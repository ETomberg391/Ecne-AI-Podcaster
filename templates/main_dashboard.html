<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecne AI Podcaster Control Panel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
</head>
<body>
    <div class="container">
        <h1>Ecne AI Podcaster Control Panel</h1>
        <p>Welcome to your centralized hub for generating podcast scripts and audio/video content.</p>

        <div class="menu-grid">
            <a href="/script_builder" class="menu-item">
                <h2>Generate Script</h2>
                <p>Create new podcast scripts using AI and various data sources.</p>
            </a>
            <a href="/podcast_builder" class="menu-item">
                <h2>Generate Podcast (Audio/Video)</h2>
                <p>Turn your scripts into full audio and video podcasts.</p>
            </a>
            <a href="/history" class="menu-item">
                <h2>History / View Outputs</h2>
                <p>Browse and manage all your generated scripts, audio, and videos.</p>
            </a>
            <a href="/settings" class="menu-item">
                <h2>Settings</h2>
                <p>Configure API keys and LLM model settings.</p>
            </a>
        </div>

        <!-- TTS Service Status Widget -->
        <div class="docker-status-widget" id="docker-status-widget">
            <h3>üéôÔ∏è TTS Service Status</h3>
            <div class="status-indicator" id="docker-status-indicator">
                <span class="status-dot" id="docker-status-dot"></span>
                <span class="status-text" id="docker-status-text">Checking...</span>
                <span class="provider-badge" id="tts-provider-badge" style="margin-left: 10px; font-size: 0.8em; color: #666;"></span>
            </div>
            <div class="docker-controls" id="docker-controls" style="display: none;">
                <button id="docker-start-btn" class="docker-btn start-btn">Start Service</button>
                <button id="docker-stop-btn" class="docker-btn stop-btn">Stop Service</button>
                <a href="http://127.0.0.1:8000/docs" target="_blank" id="tts-api-link" class="docker-btn ui-btn" style="display: none;">Open API Docs</a>
                <a href="http://127.0.0.1:5005" target="_blank" id="docker-ui-link" class="docker-btn ui-btn" style="display: none;">Open TTS UI</a>
            </div>
            <!-- Model Status Section -->
            <div id="model-status-section" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                <h4 style="margin: 0 0 10px 0; font-size: 0.9em; color: #555;">üì¶ Models</h4>
                <div id="model-list"></div>
            </div>
            <div class="docker-message" id="docker-message"></div>
        </div>
    </div>

    <script>
        // TTS Service Status Management
        let ttsStatusInterval;

        // Check TTS status on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkTTSStatus();
            // Check status every 30 seconds
            ttsStatusInterval = setInterval(checkTTSStatus, 30000);
        });

        async function checkTTSStatus() {
            try {
                const response = await fetch('/tts/status');
                const data = await response.json();
                updateTTSUI(data);
            } catch (error) {
                console.error('Error checking TTS status:', error);
                updateTTSUI({
                    status: 'error',
                    message: 'Failed to check TTS status',
                    provider: 'unknown'
                });
            }
        }

        function updateTTSUI(data) {
            const statusDot = document.getElementById('docker-status-dot');
            const statusText = document.getElementById('docker-status-text');
            const providerBadge = document.getElementById('tts-provider-badge');
            const controls = document.getElementById('docker-controls');
            const startBtn = document.getElementById('docker-start-btn');
            const stopBtn = document.getElementById('docker-stop-btn');
            const apiLink = document.getElementById('tts-api-link');
            const uiLink = document.getElementById('docker-ui-link');
            const message = document.getElementById('docker-message');

            // Update provider badge
            const provider = data.provider || 'unknown';
            providerBadge.textContent = provider === 'qwen3' ? '(Qwen3)' : provider === 'orpheus' ? '(Orpheus)' : '';

            // Update status indicator
            statusDot.className = 'status-dot';
            switch (data.status) {
                case 'running':
                    statusDot.classList.add('status-running');
                    if (provider === 'qwen3') {
                        statusText.textContent = `Running (${data.voices_available || 0} voices)`;
                    } else if (provider === 'orpheus') {
                        const containerCount = data.containers ? data.containers.filter(c => c.running).length : 0;
                        statusText.textContent = `Running (${containerCount} containers)`;
                    } else {
                        statusText.textContent = 'Running';
                    }
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-block';
                    // Show appropriate link based on provider
                    if (provider === 'qwen3') {
                        apiLink.style.display = 'inline-block';
                        uiLink.style.display = 'none';
                    } else {
                        apiLink.style.display = 'none';
                        uiLink.style.display = 'inline-block';
                    }
                    break;
                case 'stopped':
                    statusDot.classList.add('status-stopped');
                    statusText.textContent = 'Stopped';
                    startBtn.style.display = 'inline-block';
                    stopBtn.style.display = 'none';
                    apiLink.style.display = 'none';
                    uiLink.style.display = 'none';
                    break;
                case 'building':
                case 'timeout':
                    statusDot.classList.add('status-building');
                    statusText.textContent = 'Starting...';
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-block';
                    apiLink.style.display = 'none';
                    uiLink.style.display = 'none';
                    break;
                case 'not_installed':
                    statusDot.classList.add('status-error');
                    statusText.textContent = 'Not Installed';
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'none';
                    apiLink.style.display = 'none';
                    uiLink.style.display = 'none';
                    break;
                default:
                    statusDot.classList.add('status-error');
                    statusText.textContent = 'Error';
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'none';
                    apiLink.style.display = 'none';
                    uiLink.style.display = 'none';
                    break;
            }

            // Show controls if TTS service is available
            if (data.status !== 'not_installed' && data.status !== 'error') {
                controls.style.display = 'block';
            } else {
                controls.style.display = 'none';
            }

            // Update message
            message.textContent = data.message;
            
            // Update model status for Qwen3
            if (provider === 'qwen3' && data.models) {
                updateModelStatus(data.models);
            } else {
                document.getElementById('model-status-section').style.display = 'none';
            }
        }
        
        function updateModelStatus(models) {
            const section = document.getElementById('model-status-section');
            const list = document.getElementById('model-list');
            
            if (!models || models.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            list.innerHTML = '';
            
            models.forEach(model => {
                const modelDiv = document.createElement('div');
                modelDiv.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 8px; margin: 5px 0; background: #f8f9fa; border-radius: 4px; font-size: 0.85em;';
                
                const isDownloaded = model.downloaded;
                const isLoaded = model.loaded;
                const sizeInfo = model.size_gb ? `(${model.size_gb} GB)` : '';
                
                let statusIcon = '‚ùì';
                let statusText = 'Unknown';
                let statusColor = '#666';
                let buttonHtml = '';
                
                if (isLoaded) {
                    statusIcon = '‚úÖ';
                    statusText = 'Ready';
                    statusColor = '#28a745';
                    buttonHtml = '';  // No button needed
                } else if (isDownloaded) {
                    statusIcon = '‚è∏Ô∏è';
                    statusText = 'Downloaded (not loaded)';
                    statusColor = '#ffc107';
                    buttonHtml = `<button onclick="downloadModel('${model.model_id}')" class="docker-btn start-btn" style="padding: 4px 12px; font-size: 0.85em;">Load</button>`;
                } else {
                    statusIcon = '‚¨áÔ∏è';
                    statusText = 'Not Downloaded';
                    statusColor = '#dc3545';
                    buttonHtml = `<button onclick="downloadModel('${model.model_id}')" class="docker-btn start-btn" style="padding: 4px 12px; font-size: 0.85em;">Download</button>`;
                }
                
                const shortName = model.model_id.replace('qwen3-tts-1.7b-', '');
                
                modelDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span>${statusIcon}</span>
                        <span style="font-weight: 500;">${shortName}</span>
                        <span style="color: #666; font-size: 0.9em;">${sizeInfo}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="color: ${statusColor}; font-size: 0.9em;">${statusText}</span>
                        ${buttonHtml}
                    </div>
                `;
                
                list.appendChild(modelDiv);
            });
        }
        
        async function downloadModel(modelId) {
            if (!confirm(`Download and load ${modelId}? This may take a few minutes.\n\nNote: The page will not refresh automatically. Please wait for the download to complete.`)) {
                return;
            }
            
            const buttons = document.querySelectorAll(`button[onclick="downloadModel('${modelId}')"]`);
            buttons.forEach(btn => {
                btn.textContent = 'Downloading...';
                btn.disabled = true;
            });
            
            try {
                const response = await fetch(`/tts/models/download/${modelId}`, { method: 'POST' });
                const data = await response.json();
                
                if (data.status === 'success') {
                    alert(data.message);
                    // Refresh status after download
                    setTimeout(checkTTSStatus, 2000);
                } else {
                    alert('Failed: ' + data.message);
                    buttons.forEach(btn => {
                        btn.textContent = 'Download';
                        btn.disabled = false;
                    });
                }
            } catch (error) {
                console.error('Error downloading model:', error);
                alert('Error downloading model: ' + error.message);
                buttons.forEach(btn => {
                    btn.textContent = 'Download';
                    btn.disabled = false;
                });
            }
        }

        // Start TTS Service
        document.getElementById('docker-start-btn').addEventListener('click', async function() {
            if (!confirm('Do you want to start the TTS service?')) {
                return;
            }

            const button = this;
            const originalText = button.textContent;
            button.textContent = 'Starting...';
            button.disabled = true;

            try {
                const response = await fetch('/tts/start', { method: 'POST' });
                const data = await response.json();
                
                if (data.status === 'success') {
                    document.getElementById('docker-message').textContent = data.message;
                    // Check status after a short delay
                    setTimeout(checkTTSStatus, 3000);
                } else {
                    alert('Failed to start TTS service: ' + data.message);
                }
            } catch (error) {
                console.error('Error starting TTS:', error);
                alert('Error starting TTS service: ' + error.message);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        });

        // Stop TTS Service
        document.getElementById('docker-stop-btn').addEventListener('click', async function() {
            if (!confirm('Do you want to stop the TTS service?')) {
                return;
            }

            const button = this;
            const originalText = button.textContent;
            button.textContent = 'Stopping...';
            button.disabled = true;

            try {
                const response = await fetch('/tts/stop', { method: 'POST' });
                const data = await response.json();
                
                if (data.status === 'success') {
                    document.getElementById('docker-message').textContent = data.message;
                    // Check status after a short delay
                    setTimeout(checkTTSStatus, 2000);
                } else {
                    alert('Failed to stop TTS service: ' + data.message);
                }
            } catch (error) {
                console.error('Error stopping TTS:', error);
                alert('Error stopping TTS service: ' + error.message);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        });
    </script>
</body>
</html>

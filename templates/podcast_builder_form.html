<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast Audio/Video Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
</head>
<body>
    <div class="container">
        <h1>Podcast Audio/Video Generator</h1>

        <nav>
            <a href="{{ url_for('index') }}" class="back-button">Back to Dashboard</a>
        </nav>

        <form id="podcast-form">

            <h2>Script Input</h2>
            <div class="form-group">
                <label for="script_select">Select Script:</label>
                <select id="script_select" name="script_select">
                    <option value="">Loading scripts...</option>
                </select>
            </div>
            <div class="form-group" id="script_file_group" style="display: none;">
                <label for="script_file">Upload Script File (.txt):</label>
                <input type="file" id="script_file" name="script_file" accept=".txt">
            </div>

            <h2>TTS Provider</h2>
            <div class="form-group">
                <label for="tts_provider">TTS Provider:</label>
                <select id="tts_provider" name="tts_provider">
                    <option value="qwen3" selected>Qwen3 TTS (Native)</option>
                    <option value="orpheus">Orpheus TTS (Docker)</option>
                </select>
            </div>

            <h2>Voice Settings</h2>
            
            <!-- Host Voice Section -->
            <div class="voice-section">
                <h3>Host Voice</h3>
                <div class="form-group">
                    <label for="host_voice_mode">Host Voice Mode:</label>
                    <select id="host_voice_mode" name="host_voice_mode" onchange="toggleHostVoiceMode()">
                        <option value="preset" selected>Preset Speaker</option>
                        <option value="clone">Clone from Audio File</option>
                        <option value="saved">Saved Cloned Voice</option>
                    </select>
                </div>
                
                <!-- Host Preset Voice Selection -->
                <div id="host_preset_voice_group" class="form-group">
                    <label for="host_voice">Host Preset Voice:</label>
                    <select id="host_voice" name="host_voice">
                        <option value="Ryan" selected>Ryan (English - Rhythmic, Dynamic Male)</option>
                        <option value="Aiden">Aiden (English - Sunny, Clear American Male)</option>
                        <option value="Vivian">Vivian (Chinese - Bright, Sharp, Young Female)</option>
                        <option value="Serena">Serena (Chinese - Warm, Soft, Young Female)</option>
                        <option value="Uncle_Fu">Uncle_Fu (Chinese - Deep, Mellow, Mature Male)</option>
                        <option value="Dylan">Dylan (Chinese Beijing - Clear, Natural Young Male)</option>
                        <option value="Eric">Eric (Chinese Sichuan - Lively, Husky Male)</option>
                        <option value="Ono_Anna">Ono_Anna (Japanese - Light, Playful Female)</option>
                        <option value="Sohee">Sohee (Korean - Emotional, Warm Female)</option>
                    </select>
                </div>
                
                <!-- Host Clone Voice Upload -->
                <div id="host_clone_voice_group" class="form-group" style="display: none;">
                    <label for="host_voice_sample">Host Voice Sample (MP3/WAV):</label>
                    <input type="file" id="host_voice_sample" name="host_voice_sample" accept="audio/mp3,audio/wav,audio/mpeg,audio/*">
                    <div class="help-text">Upload 3+ seconds of the host's voice for cloning</div>
                </div>
                <div id="host_clone_text_group" class="form-group" style="display: none;">
                    <label for="host_voice_sample_text">Host Sample Text (Optional):</label>
                    <textarea id="host_voice_sample_text" name="host_voice_sample_text" rows="2" placeholder="Enter the text spoken in the sample (improves quality)..."></textarea>
                    <div class="help-text">Leave empty for X-Vector only mode</div>
                </div>
                
                <!-- Host Saved Voice ID -->
                <div id="host_saved_voice_group" class="form-group" style="display: none;">
                    <label for="host_saved_voice_id">Host Saved Voice ID:</label>
                    <input type="text" id="host_saved_voice_id" name="host_saved_voice_id" placeholder="e.g., voice_abc123">
                    <button type="button" class="btn-secondary" onclick="loadSavedVoices('host')">Load Saved Voices</button>
                    <div id="host_saved_voices_list" class="voice-list" style="display: none; margin-top: 10px;"></div>
                </div>
            </div>
            
            <!-- Guest Voice Section -->
            <div class="voice-section">
                <h3>Guest Voice</h3>
                <div class="form-group">
                    <label for="guest_voice_mode">Guest Voice Mode:</label>
                    <select id="guest_voice_mode" name="guest_voice_mode" onchange="toggleGuestVoiceMode()">
                        <option value="preset" selected>Preset Speaker</option>
                        <option value="clone">Clone from Audio File</option>
                        <option value="saved">Saved Cloned Voice</option>
                    </select>
                </div>
                
                <!-- Guest Preset Voice Selection -->
                <div id="guest_preset_voice_group" class="form-group">
                    <label for="guest_voice">Guest Preset Voice:</label>
                    <select id="guest_voice" name="guest_voice">
                        <option value="Serena" selected>Serena (Chinese - Warm, Soft, Young Female)</option>
                        <option value="Vivian">Vivian (Chinese - Bright, Sharp, Young Female)</option>
                        <option value="Ryan">Ryan (English - Rhythmic, Dynamic Male)</option>
                        <option value="Aiden">Aiden (English - Sunny, Clear American Male)</option>
                        <option value="Uncle_Fu">Uncle_Fu (Chinese - Deep, Mellow, Mature Male)</option>
                        <option value="Dylan">Dylan (Chinese Beijing - Clear, Natural Young Male)</option>
                        <option value="Eric">Eric (Chinese Sichuan - Lively, Husky Male)</option>
                        <option value="Ono_Anna">Ono_Anna (Japanese - Light, Playful Female)</option>
                        <option value="Sohee">Sohee (Korean - Emotional, Warm Female)</option>
                    </select>
                </div>
                
                <!-- Guest Clone Voice Upload -->
                <div id="guest_clone_voice_group" class="form-group" style="display: none;">
                    <label for="guest_voice_sample">Guest Voice Sample (MP3/WAV):</label>
                    <input type="file" id="guest_voice_sample" name="guest_voice_sample" accept="audio/mp3,audio/wav,audio/mpeg,audio/*">
                    <div class="help-text">Upload 3+ seconds of the guest's voice for cloning</div>
                </div>
                <div id="guest_clone_text_group" class="form-group" style="display: none;">
                    <label for="guest_voice_sample_text">Guest Sample Text (Optional):</label>
                    <textarea id="guest_voice_sample_text" name="guest_voice_sample_text" rows="2" placeholder="Enter the text spoken in the sample (improves quality)..."></textarea>
                    <div class="help-text">Leave empty for X-Vector only mode</div>
                </div>
                
                <!-- Guest Saved Voice ID -->
                <div id="guest_saved_voice_group" class="form-group" style="display: none;">
                    <label for="guest_saved_voice_id">Guest Saved Voice ID:</label>
                    <input type="text" id="guest_saved_voice_id" name="guest_saved_voice_id" placeholder="e.g., voice_xyz789">
                    <button type="button" class="btn-secondary" onclick="loadSavedVoices('guest')">Load Saved Voices</button>
                    <div id="guest_saved_voices_list" class="voice-list" style="display: none; margin-top: 10px;"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="speed">Speech Speed Factor (0.5 to 2.0):</label>
                <input type="number" id="speed" name="speed" value="1.0" step="0.1" min="0.5" max="2.0">
            </div>
            <div class="form-group">
                <label for="silence">Silence Duration between segments (seconds):</label>
                <input type="number" id="silence" name="silence" value="1.0" step="0.1" min="0.0">
            </div>
            <div class="form-group checkbox-group">
                <input type="checkbox" id="guest_breakup" name="guest_breakup">
                <label for="guest_breakup">Break Guest dialogue into sentences</label>
            </div>

            <button type="button" class="collapsible">Advanced Settings</button>
            <div class="content">
                <h3>Quality Presets</h3>
                <div class="form-group">
                    <label for="quality_preset">Select Quality Preset:</label>
                    <select id="quality_preset" name="quality_preset">
                        <option value="">Custom</option>
                        <option value="low">Low Quality</option>
                        <option value="medium" selected>Medium Quality</option>
                        <option value="high">High Quality</option>
                    </select>
                </div>

                <h3>API Settings</h3>
                <div class="form-group">
                    <label for="api_host">Qwen3 TTS API Host:</label>
                    <input type="text" id="api_host" name="api_host" value="127.0.0.1">
                </div>
                <div class="form-group">
                    <label for="port">Qwen3 TTS API Port:</label>
                    <input type="number" id="port" name="port" value="8000">
                </div>
                <div class="form-group">
                    <label for="tts_max_retries">TTS Max Retries (for failed requests):</label>
                    <input type="number" id="tts_max_retries" name="tts_max_retries" value="3" min="1" max="10">
                </div>
                <div class="form-group">
                    <label for="tts_timeout">TTS Timeout per request (seconds):</label>
                    <input type="number" id="tts_timeout" name="tts_timeout" value="180" min="30" max="600">
                </div>

                <h3>Output & Video Settings</h3>
                <div class="form-group">
                    <label for="output_filename">Output Base Filename (Optional):</label>
                    <input type="text" id="output_filename" name="output_filename" placeholder="e.g., my_podcast">
                </div>
                <div class="form-group">
                    <label for="video_resolution">Video Resolution:</label>
                    <select id="video_resolution" name="video_resolution">
                        <option value="1280x720">1280x720 (HD)</option>
                        <option value="1920x1080" selected>1920x1080 (Full HD)</option>
                        <option value="3840x2160">3840x2160 (4K UHD)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="video_fps">Video FPS:</label>
                    <select id="video_fps" name="video_fps">
                        <option value="24">24</option>
                        <option value="30" selected>30</option>
                        <option value="60">60</option>
                        <option value="90">90</option>
                        <option value="120">120</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="video_character_scale">Character Scale:</label>
                    <input type="number" id="video_character_scale" name="video_character_scale" value="1.0" step="0.1" min="0.1">
                </div>
                <div class="form-group">
                    <label for="video_fade">Video Fade Duration (seconds):</label>
                    <input type="number" id="video_fade" name="video_fade" value="1.0" step="0.1" min="0.0">
                </div>
                <div class="form-group">
                    <label for="video_intermediate_preset">Intermediate Encoding Preset:</label>
                    <select id="video_intermediate_preset" name="video_intermediate_preset">
                        <option value="ultrafast">ultrafast</option>
                        <option value="medium" selected>medium</option>
                        <option value="slow">slow</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="video_intermediate_crf">Intermediate CRF (0-51):</label>
                    <select id="video_intermediate_crf" name="video_intermediate_crf">
                        <option value="28">Low Quality (CRF 28)</option>
                        <option value="23" selected>Medium Quality (CRF 23)</option>
                        <option value="18">High Quality (CRF 18)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="video_final_audio_bitrate">Final Audio Bitrate:</label>
                    <select id="video_final_audio_bitrate" name="video_final_audio_bitrate">
                        <option value="96k">96k (Low Quality)</option>
                        <option value="192k" selected>192k (Medium Quality)</option>
                        <option value="320k">320k (High Quality)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="video_workers">Video Workers (CPU count default):</label>
                    <input type="number" id="video_workers" name="video_workers" min="1">
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="video_keep_temp" name="video_keep_temp">
                    <label for="video_keep_temp">Keep Temporary Video Files</label>
                </div>
            </div>

            <button type="submit" id="generate-podcast-button">Generate New Podcast</button>
            <button type="button" id="stop-podcast-button" style="background-color: #dc3545; display: none;">Stop Process</button>
        </form>

        <div class="resume-section">
            <h2>Or Resume Existing Podcast</h2>
            <div id="resume-container" class="form-group inline">
                <select id="podcast-select" name="podcast_select">
                    <option value="">Loading existing podcasts...</option>
                </select>
                <button type="button" id="load-podcast-button">Load Selected Podcast</button>
            </div>
        </div>

        <div id="podcast-results" style="display: none;">
            <h2>Result</h2>
            <p>Podcast generated successfully!</p>
            <div id="podcast-output-links"></div>
        </div>
    </div>

    <!-- Progress Modal Overlay -->
    <div id="podcast-progress-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>Generating Podcast...</h2>
            <div class="spinner"></div>
            <p id="podcast-progress-message">Initializing...</p>
            <pre id="podcast-console-output"></pre>
            <button type="button" id="close-podcast-modal-button" style="display: none;">OK</button>
        </div>
    </div>

    <style>
        .voice-section {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .voice-section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
            margin-bottom: 15px;
        }
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .voice-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background: white;
        }
        .voice-item {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }
        .voice-item:hover {
            background: #f5f5f5;
        }
        .voice-item:last-child {
            border-bottom: none;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 8px;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
    </style>
    
    <script>
        // Toggle Host Voice Mode
        function toggleHostVoiceMode() {
            const mode = document.getElementById('host_voice_mode').value;
            document.getElementById('host_preset_voice_group').style.display = mode === 'preset' ? 'block' : 'none';
            document.getElementById('host_clone_voice_group').style.display = mode === 'clone' ? 'block' : 'none';
            document.getElementById('host_clone_text_group').style.display = mode === 'clone' ? 'block' : 'none';
            document.getElementById('host_saved_voice_group').style.display = mode === 'saved' ? 'block' : 'none';
        }
        
        // Toggle Guest Voice Mode
        function toggleGuestVoiceMode() {
            const mode = document.getElementById('guest_voice_mode').value;
            document.getElementById('guest_preset_voice_group').style.display = mode === 'preset' ? 'block' : 'none';
            document.getElementById('guest_clone_voice_group').style.display = mode === 'clone' ? 'block' : 'none';
            document.getElementById('guest_clone_text_group').style.display = mode === 'clone' ? 'block' : 'none';
            document.getElementById('guest_saved_voice_group').style.display = mode === 'saved' ? 'block' : 'none';
        }
        
        // Load Saved Voices from Qwen3 API
        async function loadSavedVoices(speaker) {
            const apiHost = document.getElementById('api_host').value || '127.0.0.1';
            const apiPort = document.getElementById('port').value || '8000';
            const apiUrl = `http://${apiHost}:${apiPort}`;
            
            const listDiv = document.getElementById(speaker + '_saved_voices_list');
            listDiv.innerHTML = '<div class="help-text">Loading...</div>';
            listDiv.style.display = 'block';
            
            try {
                const response = await fetch(`${apiUrl}/v1/voices`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.voices.length === 0) {
                        listDiv.innerHTML = '<div class="help-text">No saved voices found. Clone a voice first!</div>';
                    } else {
                        let html = '';
                        data.voices.forEach(voice => {
                            html += `<div class="voice-item" onclick="document.getElementById('${speaker}_saved_voice_id').value='${voice.voice_id}'">`;
                            html += `<strong>${voice.name}</strong> (${voice.voice_id})<br>`;
                            html += `<small>${voice.description || 'No description'}</small>`;
                            html += `</div>`;
                        });
                        listDiv.innerHTML = html;
                    }
                } else {
                    listDiv.innerHTML = '<div class="help-text" style="color: red;">Failed to load voices. Is Qwen3 TTS running?</div>';
                }
            } catch (error) {
                listDiv.innerHTML = '<div class="help-text" style="color: red;">Error: ' + error.message + '</div>';
            }
        }
    </script>
    <script src="{{ url_for('static', filename='main.js') }}"></script>
</body>
</html>
